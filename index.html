<!DOCTYPE html>
<html lang="en" xmlns:x-on="http://www.w3.org/1999/xhtml" xmlns:x-mask="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Tu Vi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/mask@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
    <script type="text/javascript" src="./dist/tuvijs.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"
          crossorigin="anonymous">
    <style>
        /*!* Custom CSS to center the body horizontally *!*/
        /*body {*/
        /*    display: flex;*/
        /*    justify-content: center;*/
        /*    align-items: center;*/
        /*    min-height: 100vh; !* Set the body's minimum height to the viewport height *!*/
        /*}*/

        table {
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 10px;
            text-align: left;
            position: relative;
            vertical-align: top;
            min-width: 210px;
        }

        #thien-ban,
        #thien-ban th,
        #thien-ban td {
            border: none;
            min-width: auto;
        }

        .absolute {
            position: absolute;
        }

        .bottom-0 {
            position: absolute;
            bottom: 2px;
            left: 0;
            width: 100%;
        }

        .float-left {
            float: left;
            text-align: left;
        }

        .float-right {
            float: right;
            text-align: left;
        }

        .clearfix {
            display: block;
        }

        .clearfix:after {
            content: "\0020";
            display: block;
            height: 0;
            clear: both;
            visibility: hidden;
            overflow: hidden;
        }

        .text-center {
            text-align: center;
        }

        .phu-tinh {
            padding-bottom: 12px;
        }
    </style>
</head>
<body>
<div x-data="app" class="mx-auto px-10">
    <form class="w-full max-w-lg mx-auto">
        <h4 class="text-center mb-2 mt-0 text-2xl font-medium leading-tight text-primary">
            Lấy Lá Số Tử Vi
        </h4>
        <div class="flex flex-wrap -mx-3 mb-2">
            <div class="w-full md:w-1/5 px-3 mb-2 md:mb-0">
                <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="grid-state">
                    Năm
                </label>
                <div class="relative">
                    <select x-model="year" x-on:change="onDateTimeChange($event)" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500" id="grid-state">
                        <template x-for="yyyy in years">
                            <option x-text="yyyy" :selected="yyyy == year"></option>
                        </template>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/5 px-3 mb-2 md:mb-0">
                <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="grid-state">
                    Tháng
                </label>
                <div class="relative">
                    <select x-model="month" x-on:change="onDateTimeChange($event)" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500" id="grid-state">
                        <template x-for="mm in months">
                            <option x-html="mm" :selected="mm == month"></option>
                        </template>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/5 px-3 mb-2 md:mb-0">
                <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="grid-state">
                    Ngày
                </label>
                <div class="relative">
                    <select x-model="day" x-on:change="onDateTimeChange($event)" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500" id="grid-state">
                        <template x-for="dd in days">
                            <option x-text="dd" :selected="dd == day"></option>
                        </template>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/5 px-3 mb-2 md:mb-0">
                <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="grid-state">
                    GIờ
                </label>
                <div class="relative">
                    <select x-model="hour" x-on:change="onDateTimeChange($event)" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500" id="grid-state">
                        <template x-for="hh in hours">
                            <option x-text="hh" :selected="hh == hour"></option>
                        </template>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/5 px-3 mb-2 md:mb-0">
                <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="grid-state">
                    Phút
                </label>
                <div class="relative">
                    <select x-model="minute" x-on:change="onDateTimeChange($event)" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500" id="grid-state">
                        <template x-for="mm in minutes">
                            <option x-text="mm" :selected="mm == minute"></option>
                        </template>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex flex-wrap -mx-3 mb-2">
            <div class="w-full md:w-2/5 px-3">
                <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="grid-state">
                    Ngày Giờ Sinh
                </label>
                <input class="block w-full bg-gray-200 text-gray-700 border rounded py-3 px-4 mb-3 leading-tight" id="datetime" type="text"
                       x-mask:function="formatDateTime" x-model="datetime"
                       @keydown.enter="xem()" @keydown.n="toggleGioiTinh()">
                <input type="text" class="hidden" x-mask:function="formatDateTime" x-model="datetime"
                       @keydown.enter="xem()" @keydown.n="toggleGioiTinh()">

            </div>
            <div class="w-full md:w-1/5 px-3 mb-2 md:mb-0">
                <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="grid-state">
                    Lịch
                </label>
                <div class="relative">
                    <select x-model="lich" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-3 px-2 pr-2 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500" id="grid-state">
                        <option>Dương</option>
                        <option>Âm</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/5 px-3 mb-2 md:mb-0">
                <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="grid-state">
                    Giới Tính
                </label>
                <div class="relative">
                    <select x-model="gioiTinh" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-3 px-2 pr-2 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500" id="grid-state">
                        <option>Nam</option>
                        <option>Nữ</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/5 px-3">
                <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="grid-state">
                    &nbsp;
                </label>
                <button x-bind="bindData" class="bg-blue-500 hover:bg-blue-700 w-full text-white font-bold py-3 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    Xem
                </button>
            </div>
        </div>
    </form>

    <template x-if="laso != null">
        <table id="laso" class="w-full max-w-lg mx-auto mb-2">
            <template x-for="row in 4">
                <tr>
                    <template x-for="col in 4">
                        <template x-if="matrix[row - 1][col - 1] != null">
                            <td :colspan="matrix[row - 1][col - 1] == 'merged' ? 2 : 1"
                                :rowspan="matrix[row - 1][col - 1] == 'merged' ? 2 : 1">
                                <template x-if="matrix[row - 1][col - 1].cungChuc != null">
                                    <div>
                                        <div class="font-bold text-center">
                                            <span x-html="matrix[row - 1][col - 1].cungChuc.name"></span>
                                            <template x-if="matrix[row - 1][col - 1].cungThan"><span>(Thân)</span>
                                            </template>
                                            <div>
                                                <template x-for="chinhTinh in matrix[row - 1][col - 1].chinhTinh"
                                                          :key="chinhTinh.name">
                                                    <span class="" x-html="chinhTinh.name + ' '"></span>
                                                </template>
                                                <template x-if="matrix[row - 1][col - 1].chinhTinh.length == 0">
                                                    <span class="" x-html="'&nbsp;'"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="clearfix phu-tinh">
                                            <div class="float-left">
                                                <template x-for="catTinh in matrix[row - 1][col - 1].phuTinhTot">
                                                    <div>
                                                        <span :class="setPhuTinhClass(catTinh)"
                                                              x-html="catTinh.name"></span>
                                                    </div>
                                                </template>
                                            </div>
                                            <div class="float-right">
                                                <template x-for="satTinh in matrix[row - 1][col - 1].phuTinhXau">
                                                    <div :class="setPhuTinhClass(satTinh)" x-html="satTinh.name"></div>
                                                </template>
                                            </div>
                                        </div>

                                        <div class="absolute bottom-0 text-center flex justify-between px-2 text-sm">
                                            <span x-html="matrix[row - 1][col - 1].tieuVan.name"></span>
                                            <span x-html="matrix[row - 1][col - 1].can.name + ' ' + matrix[row - 1][col - 1].chi.name"></span>
                                            <span x-html="matrix[row - 1][col - 1].daiVan"></span>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="matrix[row - 1][col - 1] == 'merged'">
                                    <div>
                                        <table id="thien-ban" class="font-bold">
                                            <tr>
                                                <td x-text="'Cục:'"></td>
                                                <td x-html="laso.cuc.cucName"></td>
                                            </tr>
                                            <tr>
                                                <td x-text="'Mệnh:'"></td>
                                                <td x-html="laso.menh.name"></td>
                                            </tr>
                                            <tr>
                                                <td x-text="'Dương Lịch: '"></td>
                                                <td x-html="laso.duongLich.format('YYYY-MM-DD HH:mm')"></td>
                                            </tr>
                                            <tr>
                                                <td x-text="'Ngày: '"></td>
                                                <td x-html="pad00(laso.amLich.ngay.val) + ' ' + laso.amLich.ngay.can.name + ' ' + laso.amLich.ngay.chi.name"></td>
                                            </tr>
                                            <tr>
                                                <td x-text="'Tháng: '"></td>
                                                <td x-html="pad00(laso.amLich.thang.val) + ' ' + laso.amLich.thang.can.name + ' ' + laso.amLich.thang.chi.name"></td>
                                            </tr>
                                            <tr>
                                                <td x-text="'Năm: '"></td>
                                                <td x-html="laso.amLich.nam.can.name + ' ' + laso.amLich.nam.chi.name"></td>
                                            </tr>
                                            <tr>
                                                <td x-text="'Giờ: '"></td>
                                                <td x-html="laso.amLich.gio.can.name + ' ' + laso.amLich.gio.chi.name"></td>
                                            </tr>
                                            <tr>
                                                <td x-text="'Giới Tính: '"></td>
                                                <td x-html="laso.amLich.nam.can.amDuong.name + ' ' + laso.gioiTinh.gioiTinh"></td>
                                            </tr>
                                        </table>
                                    </div>
                                </template>
                            </td>
                        </template>
                    </template>
                </tr>
            </template>
        </table>
    </template>
</div>
<script type="text/javascript">
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = pad00(currentDate.getMonth() + 1);
    const currentDay = pad00(currentDate.getDate());
    const currentHour = pad00(currentDate.getHours());
    const currentMinute = pad00(currentDate.getMinutes());

    // Generate an array of years from 1900 to the current year
    const years = [];
    const months = [];
    const days = [];
    const hours = [];
    const minutes = [];
    for (let year = 1900; year <= currentYear + 60; year++) {
        years.push(year);
    }

    for (let month = 1; month <= 12; month++) {
        months.push(pad00(month));
    }

    for (let day = 1; day <= 31; day++) {
        days.push(pad00(day));
    }

    for (let hour = 0; hour <= 23; hour++) {
        hours.push(pad00(hour));
    }

    for (let minute = 0; minute <= 59; minute++) {
        minutes.push(pad00(minute));
    }

    function formatDateTime(input) {
        return '9999-99-99 99:99';
    }

    function setPhuTinhClass(sao) {
        if (sao.group != null) {
            if (sao.group.val === 'Lục Cát') {
                return 'font-bold text-green-600';
            }
            if (sao.group.val === 'Lục Sát') {
                return 'font-bold text-red-600';
            }
            if (sao.group.val === 'Tứ Hóa') {
                return 'font-bold text-yellow-600';
            }

            if (sao.group.val === 'Tam Minh') {
                return 'font-bold text-pink-600';
            }
        }

        if (sao.name === "Tuần" || sao.name === "Triệt") {
            return 'bg-gray-200 rounded py-px px-1';
        }
    }

    function pad00(str) {
        return String(str).padStart(2, '0');
    }

    document.addEventListener('alpine:init', () => {
        Alpine.data('app', () => ({
            init() {
                this.datetime = this.d != null ? this.d : this.datetime;
                this.gioiTinh = this.s != null ? this.s : this.gioiTinh;
                this.lich = this.c != null ? this.c : this.lich;
                if (this.d != null) {
                    this.xem();
                }
            },
            d: new URLSearchParams(location.search).get('d'),
            s: new URLSearchParams(location.search).get('s'),
            c: new URLSearchParams(location.search).get('c'),
            laso: null,
            matrix: null,
            year: currentYear,
            month: currentMonth,
            day: currentDay,
            hour: currentHour,
            minute: currentMinute,
            gioiTinh: 'Nam',
            lich: 'Dương',
            datetime: `${currentYear}-${currentMonth}-${currentDay} ${currentHour}:${currentMinute}`,
            onDateTimeChange() {
                this.datetime = `${this.year}-${pad00(this.month)}-${pad00(this.day)} ${pad00(this.hour)}:${pad00(this.minute)}`;
            },
            xem() {
                this.laso = tuvi.LaSo.new(this.datetime, tuvi.GioiTinh.from(this.gioiTinh), tuvi.AmDuong.from(this.lich));
                this.matrix = Array.from({length: 4}, () => Array(4).fill(null));
                this.matrix[0][0] = this.laso.getCungVi(tuvi.Chi.Tị);
                this.matrix[0][1] = this.laso.getCungVi(tuvi.Chi.Ngọ);
                this.matrix[0][2] = this.laso.getCungVi(tuvi.Chi.Mùi);
                this.matrix[0][3] = this.laso.getCungVi(tuvi.Chi.Thân);

                this.matrix[1][0] = this.laso.getCungVi(tuvi.Chi.Thìn);
                this.matrix[1][1] = "merged";
                this.matrix[1][3] = this.laso.getCungVi(tuvi.Chi.Dậu);

                this.matrix[2][0] = this.laso.getCungVi(tuvi.Chi.Mão);
                this.matrix[2][3] = this.laso.getCungVi(tuvi.Chi.Tuất);

                this.matrix[3][0] = this.laso.getCungVi(tuvi.Chi.Dần);
                this.matrix[3][1] = this.laso.getCungVi(tuvi.Chi.Sửu);
                this.matrix[3][2] = this.laso.getCungVi(tuvi.Chi.Tý);
                this.matrix[3][3] = this.laso.getCungVi(tuvi.Chi.Hợi);

                this.year = this.laso.duongLich.year();
                this.month = this.laso.duongLich.month() + 1;
                this.day = this.laso.duongLich.date();
                this.hour = this.laso.duongLich.hour();
                this.minute = this.laso.duongLich.minute();
                console.log(this.laso);

                const url = new URL(window.location.href);
                url.searchParams.set('d', this.datetime);
                url.searchParams.set('s', this.gioiTinh);
                url.searchParams.set('c', this.lich);
                history.pushState(null, document.title, url.toString());
            },
            toggleGioiTinh() {
                this.gioiTinh = this.gioiTinh == "Nam" ? "Nữ" : "Nam";
            },
            downloadImg() {
                html2canvas(document.querySelector("#laso")).then(canvas => {
                    // let link = document.createElement("a");
                    // document.body.appendChild(link);
                    // link.download = "html_image.png";
                    // link.href = canvas.toDataURL("image/png");
                    // link.target = '_blank';
                    // link.click();
                    document.body.appendChild(canvas);
                });

            },
            bindData: {
                ['@click']() {
                    this.xem();
                },
            }
        }))
    })
</script>
</body>
</html>